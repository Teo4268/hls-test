<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MP3 Chunk Player</title>
</head>
<body>
  <h2>Phát MP3 theo chunk (giống Telegram)</h2>
  <audio id="player" controls></audio>

  <script>
    // Link mp3 Kaggle
    const audioUrl = "https://www.kaggle.com/api/v1/datasets/download/teo30393o3/music766/5_6217735145516963170.mp3";

    // Chunk size: 256KB
    const chunkSize = 256 * 1024;
    let mediaSource = new MediaSource();
    let audio = document.getElementById("player");
    audio.src = URL.createObjectURL(mediaSource);

    mediaSource.addEventListener("sourceopen", () => {
      let sourceBuffer = mediaSource.addSourceBuffer('audio/mpeg');
      let offset = 0;

      async function fetchChunk() {
        let headers = { Range: `bytes=${offset}-${offset + chunkSize - 1}` };
        try {
          let resp = await fetch(audioUrl, { headers });
          if (!resp.ok) {
            console.log("Kết thúc hoặc lỗi:", resp.status);
            mediaSource.endOfStream();
            return;
          }

          let data = await resp.arrayBuffer();
          if (data.byteLength > 0) {
            offset += data.byteLength;
            sourceBuffer.appendBuffer(data);
            sourceBuffer.addEventListener("updateend", () => {
              fetchChunk();
            }, { once: true });
          } else {
            mediaSource.endOfStream();
          }
        } catch (e) {
          console.error("Lỗi fetch chunk:", e);
          mediaSource.endOfStream();
        }
      }

      fetchChunk();
    });
  </script>
</body>
</html>
